<% layout("/layouts/bolierplate") %>
<style>
.filter-section {
    background-color: #f7f7f7;
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
    margin-bottom: 1rem;
}
.filter-group {
    flex: 1;
    min-width: 200px;
}
.filter-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    font-size: 0.9rem;
    color: #333;
}
.filter-group input,
.filter-group select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 0.9rem;
}
.price-range {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}
.price-range input {
    flex: 1;
}
.btn-filter {
    background-color: #fe424d;
    color: white;
    border: none;
    padding: 0.5rem 1.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s;
}
.btn-filter:hover {
    background-color: #e63946;
}
.btn-clear {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 0.5rem 1.5rem;
    border-radius: 8px;
    cursor: pointer;
    margin-left: 0.5rem;
}
.results-info {
    margin-bottom: 1rem;
    color: #666;
    font-size: 0.95rem;
}
</style>

<div class="container mt-4">
    <div class="filter-section">
        <form method="GET" action="/listings" id="filterForm">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="location"><i class="fa-solid fa-location-dot"></i> Location</label>
                    <input type="text" name="location" id="location" placeholder="City or Country" value="<%= location %>">
                </div>
                <div class="filter-group">
                    <label for="minPrice"><i class="fa-solid fa-indian-rupee-sign"></i> Min Price</label>
                    <input type="number" name="minPrice" id="minPrice" placeholder="Min" value="<%= minPrice %>" min="0">
                </div>
                <div class="filter-group">
                    <label for="maxPrice"><i class="fa-solid fa-indian-rupee-sign"></i> Max Price</label>
                    <input type="number" name="maxPrice" id="maxPrice" placeholder="Max" value="<%= maxPrice %>" min="0">
                </div>
                <div class="filter-group">
                    <label for="sort"><i class="fa-solid fa-sort"></i> Sort By</label>
                    <select name="sort" id="sort">
                        <option value="newest" <%= sort === 'newest' ? 'selected' : '' %>>Newest First</option>
                        <option value="oldest" <%= sort === 'oldest' ? 'selected' : '' %>>Oldest First</option>
                        <option value="price-low" <%= sort === 'price-low' ? 'selected' : '' %>>Price: Low to High</option>
                        <option value="price-high" <%= sort === 'price-high' ? 'selected' : '' %>>Price: High to Low</option>
                    </select>
                </div>
            </div>
            <div class="filter-row">
                <input type="hidden" name="search" value="<%= search %>">
                <button type="submit" class="btn-filter"><i class="fa-solid fa-filter"></i> Apply Filters</button>
                <a href="/listings" class="btn btn-clear">Clear</a>
            </div>
        </form>
    </div>

    <div class="results-info">
        Found <strong><%= allListings.length %></strong> listing<%= allListings.length !== 1 ? 's' : '' %>
        <% if (search || location) { %>
            <% if (search) { %> matching "<%= search %>"<% } %>
            <% if (location) { %> in <%= location %><% } %>
        <% } %>
    </div>

    <% if (allListings.length === 0) { %>
        <div class="alert alert-info text-center">
            <h4>No listings found</h4>
            <p>Try adjusting your search or filters</p>
            <a href="/listings" class="btn btn-primary">View All Listings</a>
        </div>
    <% } else { %>
        <div class="row row-cols-lg-3 row-cols-md-2 row-cols-sm-1 g-4">
            <% for(let listing of allListings){%>
                        <div class="col">
                    <a href="/listings/<%= listing._id %>" class="text-decoration-none listing-links">
                        <div class="card h-100 listing-card shadow-sm">
                            <img src="<%=listing.image.url %>" class="card-img-top" alt="<%= listing.title %>" style="height: 20rem; object-fit: cover;">
                            <div class="card-body">
                                <h5 class="card-title text-dark"><%= listing.title %></h5>
                                <p class="card-text text-muted mb-2">
                                    <i class="fa-solid fa-location-dot"></i> 
                                    <%= listing.location %><% if (listing.country) { %>, <%= listing.country %><% } %>
                                </p>
                                <% if (listing.reviews && listing.reviews.length > 0) { %>
                                    <% 
                                        let totalRating = 0;
                                        let reviewCount = 0;
                                        listing.reviews.forEach(function(review) {
                                            if (typeof review === 'object' && review.rating) {
                                                totalRating += review.rating;
                                                reviewCount++;
                                            }
                                        });
                                        let avgRating = reviewCount > 0 ? (totalRating / reviewCount).toFixed(1) : 0;
                                    %>
                                    <% if (avgRating > 0) { %>
                                        <p class="card-text mb-2">
                                            <span class="starability-result d-inline-block" data-rating="<%= Math.round(avgRating) %>" style="width: 100px;"></span>
                                            <span class="ms-2"><%= avgRating %></span>
                                            <span class="text-muted">(<%= reviewCount %>)</span>
                                        </p>
                                    <% } %>
                                <% } %>
                                <p class="card-text mb-0">
                                    <strong class="text-dark">â‚¹<%= listing.price.toLocaleString("en-IN") %></strong>
                                    <span class="text-muted">/night</span>
                                </p>
                            </div>
                        </div>
                    </a>
                </div>
            <%}%>
        </div>
    <% } %>
</div>
    